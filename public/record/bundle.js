if(Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n=this.length;for("undefined"==typeof t&&(t=0),t=Number(t),t=0>t?Math.ceil(t):Math.floor(t),0>t&&(t+=n);n>t;t++)if(t in this&&this[t]===e)return t;return-1}),Array.prototype.filter||(Array.prototype.filter=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("filter: not a function");for(var r=new Array,i=0;n>i;i++)if(i in this){var o=this[i];e.call(t,o,i,this)&&r.push(o)}return r}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("forEach: not a function");for(var r=0;n>r;r++)r in this&&e.call(t,this[r],r,this)}),Array.prototype.every||(Array.prototype.every=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("every: not a function");for(var r=0;n>r;r++)if(r in this&&!e.call(t,this[r],r,this))return!1;return!0}),Array.prototype.map||(Array.prototype.map=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("map: not a function");for(var r=new Array(n),i=0;n>i;i++)i in this&&(r[i]=e.call(t,this[i],i,this));return r}),Array.prototype.some||(Array.prototype.some=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("some: not a function");for(var r=0;n>r;r++)if(r in this&&e.call(t,this[r],r,this))return!0;return!1}),Array.prototype.reduce||(Array.prototype.reduce=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("reduce: not a function ");var r,i=0;if("undefined"!=typeof t)r=t;else for(;;){if(i in this){r=this[i++];break}if(++i>=n)throw new TypeError("reduce: empty array")}for(;n>i;i++)i in this&&(r=e.call(null,r,this[i],i,this));return r}),Array.prototype.reduceRight||(Array.prototype.reduceRight=function(e,t){var n=this.length;if("function"!=typeof e)throw new TypeError("reduceRight: not a function");var r,i=n-1;if("undefined"!=typeof t)r=t;else for(;;){if(i in this){r=this[i--];break}if(--i<0)throw new TypeError("reduceRight: empty array")}for(;i>=0;i--)i in this&&(r=e.call(null,r,this[i],i,this));return r}),"undefined"==typeof GNN)var GNN={};!function(){var e=function(t,n){n=n||{};for(var r in n)null===t[r]||"object"!=typeof n[r]||"object"!=typeof t[r]?t[r]=n[r]:e(t[r],n[r]);return t};GNN.override=e;var t=function(e,t){var n=e||{};for(var r in t)"undefined"==typeof n[r]&&(n[r]=t[r]);return n};GNN.inherit=t;var n=function(e,t){for(var n in e)t(n,e[n])},r=function(){var e={},t=[];return t.push.apply(t,arguments),t.forEach(function(t){n(t,function(t,n){"undefined"==typeof e[t]&&(e[t]=n)})}),e};GNN.Hash=GNN.Hash||{},GNN.Hash.forEach=n,GNN.Hash.merge=r}(),["GNN",function(e){var t=this.pop();"undefined"==typeof e[t]&&(e[t]={});var n,r=e[t];n=r.URI=function i(e){if(!(this instanceof i))return new i(e);var t;new RegExp("^([^:]+)://").test(e)&&(t=RegExp.$1);var n=e.replace(new RegExp("^([^:]+)://"),"").split("/"),r=n.shift(),o={},a=n.pop(),s="?";a&&/[=?]/.test(a)?(/^(.*?)\?(.*)$/.test(a)&&(n.push(RegExp.$1),a=RegExp.$2),a.split(/&/).forEach(function(e){/^([^=]+)=(.*)$/.test(e)?o[RegExp.$1]=RegExp.$2:(o._flags=o._flags||[],o._flags.push(e))})):n.push(a),this.scheme=t,this.domain=r,this.local=n,this.params=o,this.q=s},n.prototype={data:function(){var e=[];for(var t in this.params)if("undefined"!=typeof this.params[t])if("_flags"==t)e=e.concat(this.params[t]);else{var r=this.params[t],i=n.encode(r+"");e.push(t+"="+(/%/.test(r)?r:i))}return e.join("&")},toLocalPath:function(){var e=this.data(),t=this.local.join("/");return"/"+(e.length?t+this.q+e:t)},toString:function(){var e=this.toLocalPath(),t=this.domain+e;return this.scheme&&(t=this.scheme+"://"+t),t}},n.prototype.constructor=n,n.encode=function(e,t){t=t||"[^\\w\\d]";for(var n="",r=e.length,i=0;r>i;i++){var o=e.charAt(i),a=e.charCodeAt(i);n+=!new RegExp("^"+t+"$").test(o)||o>255?o:"%"+a.toString(16)}return n},n.location=function(){return new n(location.href)},n.params=function(e){e=e||{};var t=n.location();for(var r in e)t.params[r]=e[r];return t}}].reverse()[0](this),["GNN",function(e){var t=this.pop();"undefined"==typeof e[t]&&(e[t]={});var n,r=e[t],i=r.URI;n=r.XHR=function(e,t,r){return n.get(e,t,r)},n.callback={},n.maxConnections=8,n.retryDelay=100,n.defaultTimeout=2e4;var o=[],a={q:[],push:function(e){this.q.push(e),1==this.q.length&&this.process()},pop:function(){if(o.length<n.maxConnections){var e=this.q.shift();return e&&e(),!0}return!1},process:function(){for(;this.q.length>0&&this.pop(););if(this.q.length>0){var e=this;setTimeout(function(){e.process()},n.retryDelay)}}},s=[XMLHttpRequest,JSON].every(function(e){return"undefined"!=typeof e}),c=function(e,t,r,s,c,u){r instanceof i||(r=new i(r+"")),s=s||function(){},c=c||function(){};var l={uri:r+""};l.callback=function(){var e=s.apply(null,arguments);return l.stop(),e},l.error=function(){var e=c.apply(null,arguments);return l.stop(),e},l.stop=function(){l.done=!0,o=o.filter(function(e){return!e.done})},"undefined"==typeof r.params.timestamp&&(r.params.timestamp=encodeURI(new Date)),"undefined"==typeof u&&(u=n.defaultTimeout);var d=function(){if(o.push(l),u&&setTimeout(function(){l.done||l.error("timeout",l,u)},u),!t(l,r)){var n=new XMLHttpRequest;l.req=n,l.stop_=l.stop,l.stop=function(){n.abort(),l.stop_(),l.callback=function(){},l.error=function(){}};var i=null;"POST"==e&&(i=r.data(),r.params={}),n.open(e,r+""),n.onreadystatechange=function(){4==n.readyState&&(200<=n.status&&n.status<300?l.callback(n):l.error("request",n))},n.send(i)}};return a.push(d),l},u=function(e,t,r,i){var o;"undefined"!=typeof t.timeout&&(o=t.timeout,delete t.timeout);var a=function(){};if("object"==typeof t.async){var s=t.async,c={};delete t.async;for(var u in s)s[u].done=!1;a=function(e,t){for(var n in s){var r=s[n].keys||[n];if(!c[n]&&r.every(function(t){return e.indexOf(t)<0})){c[n]=!0;var i=s[n].callback||s[n];"function"==typeof i&&i(t)}}}}r=r||function(){};var l=[],d={},f=!1,p={};for(var h in t)l.push(h);var v=l.concat([]);i=i||function(){};var m=function(e){return function(t){if("timeout"==t)v.length&&(l=[],f=!0,v.forEach(function(e){p[e]&&p[e].stop()}),i(t,p,v,arguments[2]));else{var n=Array.prototype.slice.apply(arguments);n.push([e]),i.apply(null,n)}}},N=function(){if(l.length>0){var i=l.shift();p[i]=n[e](t[i],function(e){d[i]=e,v=v.filter(function(e){return e!=i}),a(v,d),v.length||f||r(d)},m(i),o),setTimeout(N,0)}};return N(),{stop:function(){for(;v.length>0;)p[v.shift()].stop()}}};n.get=function(e,t,n,r){return c("GET",function(){return!1},e,t,n,r)},n.post=function(e,t,n,r){return c("POST",function(){return!1},e,t,n,r)},n.retrieve=function(e,t,n){return u("get",e,t,n)};var l=function(e,r){for(var i=[["%","_"],["-","_"],["\\*","_"],["\\.","_"]].reduce(function(e,t){return e.replace(new RegExp(t[0],"g"),t[1])},escape(encodeURIComponent(e.uri)));n.callback[i];)i+="_";e.stop_=e.stop,e.stop=function(){e.stop_(),delete n.callback[i]},n.callback[i]=e.callback,r.params.callback=[t,"XHR.callback",i].join("."),e.script=document.createElement("script"),e.script.src=r+"",e.script.type="text/javascript";var o=document.getElementsByTagName("head")[0];return o.appendChild(e.script),!0};n.json=function(e,t,n,r){var i=l;if(s){i=function(){return!1};var o=t||function(){};n=n||function(){},t=function(e){var t;try{t=JSON.parse(e.responseText)}catch(r){n("request",e)}o(t)}}return c("GET",i,e,t,n,r)},n.json.retrieve=function(e,t,n){return u("json",e,t,n)},n.jsonp=function(e,t,n,r){return c("GET",l,e,t,n,r)},n.jsonp.retrieve=function(e,t,n){return u("jsonp",e,t,n)}}].reverse()[0](this),"undefined"==typeof GNN.UI&&(GNN.UI={}),function(e){var t=GNN.Hash.forEach;e.doc=function(){return e.document||document},e.isNode=function(e){return e&&"number"==typeof e.nodeType},e.text=function(e){return e.textContent||e.innerText||""},e._$=function(t){return e.doc().getElementById(t)},e.$=function(t){return e.isNode(t)?t:e._$(t)},e.$new=function(n,r){var i=e.doc().createElement(n);if(r=r||{},r.id&&(i.id=r.id),r.klass&&(i.className=r.klass),t(r.style||{},function(e,t){i.style[e]=t}),r.attr)for(var o in r.attr)i.setAttribute(o,r.attr[o]);if("undefined"!=typeof r.child){r.child instanceof Array||(r.child=[r.child]);for(var a=0;a<r.child.length;a++){var s=e.$node(r.child[a]);i.appendChild(s)}}return i},e.$text=function(t){return("undefined"==typeof t||null==t)&&(t=""),e.doc().createTextNode(t+"")},e.$node=function(t){return e.isNode(t)?t:e.$text(t)},e.$select=function(t){t.klass||(t.klass=[]),t.klass instanceof Array||(t.klass=[t.klass]);for(var n=t.root||e.doc(),r=n.getElementsByTagName(t.tag),i=[],o=0;o<r.length;o++){var a=e.classNames(r[o]);t.klass.every(function(e){return a.indexOf(e)>=0})&&i.push(r[o])}return i},e.classNames=function(e){return(e.className||"").split(/\s+/)},e.hasClass=function(t,n){return e.classNames(t).indexOf(n)>=0},e.appendClass=function(t,n){t.className=e.classNames(t).filter(function(e){return e!=n}).concat([n]).join(" ")},e.removeClass=function(t,n){t.className=e.classNames(t).filter(function(e){return e!=n}).join(" ")},e.removeAllChildren=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},e.replaceLastChild=function(e,t){var n=e.lastChild;n&&e.removeChild(n),e.appendChild(t)},e.insertText=function(e,t){var n=e.selectionStart,r=e.selectionEnd;if("number"==typeof n&&"number"==typeof r){var i=e.value.substring(0,n),o=e.value.substring(r);e.value=i+t+o,e.selectionStart=e.selectionEnd=n+t.length}else e.value+=t},e.getStyle=function(t,n){var r=(t.style||{})[n];if(!r){var i=e.doc().defaultView||{};if(i.getComputedStyle)try{var o=i.getComputedStyle(t,null);n=n.replace(/([A-Z])/g,"-$1").toLowerCase(),r=o?o.getPropertyValue(n):null}catch(a){return null}else t.currentStyle&&(r=t.currentStyle[n])}return r},e.getPosition=function(e){var t={x:0,y:0};do t.x+=e.offsetLeft,t.y+=e.offsetTop;while(e=e.offsetParent);return t},e.getMousePosition=function(t){if(-1!=navigator.userAgent.indexOf("Chrome/")&&navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Version/")<0)return{x:t.clientX,y:t.clientY};var n={},r=e.doc().documentElement;return window.innerWidth?(n.x=window.pageXOffset,n.y=window.pageYOffset):r&&r.clientWidth?(n.x=r.scrollLeft,n.y=r.scrollTop):e.doc().body.clientWidth&&(n.x=e.doc().body.scrollLeft,n.y=e.doc().body.scrollTop),{x:t.clientX+n.x,y:t.clientY+n.y}},e.Event=function(t){var n={event:t};return n.mousePos=function(){return e.getMousePosition(n.event)},n.stopPropagation=function(){n.event.stopPropagation?n.event.stopPropagation():n.event.cancelBubble=!0},n.preventDefault=function(){n.event.preventDefault?n.event.preventDefault():n.event.returnValue=!1},n.stop=function(){n.stopPropagation(),n.preventDefault()},n.target=function(){return n.event.target||n.event.srcElement},n.disable=function(){n.target().disabled=!0},n.enable=function(){n.target().disabled=!1},n},e.Observer=function(t,n,r,i){var o={node:t,event:n},a=r;"string"==typeof i?a=r[i]:"undefined"!=typeof i&&(a=i);var s=function(t){return a.call(r,new e.Event(t))};return o.start=function(){o.node.addEventListener?(0===n.indexOf("on")&&(o.event=n.substr(2)),o.node.addEventListener(o.event,s,!1)):o.node.attachEvent&&o.node.attachEvent(o.event,s)},o.stop=function(){o.node.removeEventListener?o.node.removeEventListener(o.event,s,!1):o.node.detachEvent&&o.node.detachEvent(o.event,s)},o.start(),o}}(GNN.UI);var FileBrowser=function(e){var t=GNN.UI.$new,n=GNN.UI.$text;return e.FileViewer=function(e){return e=e||document,{view:t("table",{klass:"file_browser file"}),applyStyleFromSource:function(e){e=e.replace(/[\r\n]/g,"");var t="<style[^>]*>(?:<!--)?(.*?)(?:-->)?</style>";if(new RegExp(t).test(e)){for(var n,r=RegExp.$1,i=new RegExp("\\s*([^{]+?)\\s*{([^}]*)}","g"),o=[];null!=(n=i.exec(r));)"."==n[1].charAt(0)&&o.push({selector:n[1],style:n[2]});return this.applyStyle(o)}},applyStyle:function(r){if(e.styleSheets[0].addRule)return r.forEach(function(t){e.styleSheets[0].addRule(t.selector,t.style)}),!0;var i=t("style",{attr:{type:"text/css"}});i.appendChild(n(r.map(function(e){return e.selector+"{"+e.style+"}"}).join("\n")));var o=e.getElementsByTagName("head")[0];return o?(o.appendChild(i),!0):void 0},open:function(e){GNN.UI.removeAllChildren(this.view);var r=t("tr");"\n"!=e.charAt(e.length-1)&&(e+="\n");for(var i,o=t("pre"),a=1,s=new RegExp("\n","g");null!=(i=s.exec(e));)o.appendChild(n(a++ +"\n"));r.appendChild(t("td",{klass:"linenumber",child:o}));var c=t("td",{klass:"content",child:pre});c.innerHTML="<pre>"+e+"</pre>",r.appendChild(c),this.view.appendChild(r)}}},e}(function(e){var t=GNN.UI.$new,n=GNN.UI.$text,r=function(e){var t,n=["","K","M","G","T","P","E","Z","Y"];for(t=0;e>=1024&&t<n.length-1;t++)e/=1024;return t>0&&(e=e.toFixed(1)),e+n[t]},i=e.handler||{};i.dir=i.dir||function(){},i.file=i.file||function(){},i.path=i.path||function(e){return e},i.icon=i.icon||function(){};var o={view:t("table",{klass:"file_browser"})};return o.onMove=function(e){i.onMove?i.onMove(e):o.move(e)},o.move=function(e){"dir"==e.type?i.dir(e,function(a){return GNN.UI.removeAllChildren(o.view),o.view.appendChild(t("tr",{child:[["ファイル","file"],["サイズ","size"],["更新日時","time"]].map(function(e){return t("th",{child:e[0],klass:e[1]})})})),a.forEach(function(a){var s=e.path+"/"+a.name,c={path:s,name:a.name,type:a.type,time:a.time},u=t("a",{attr:{href:i.path(c)},child:n(a.name+("dir"==a.type?"/":""))});"bin"!=a.type&&new GNN.UI.Observer(u,"onclick",function(e){e.stop(),o.onMove(c)});var l=[u],d=i.icon(a);d&&l.unshift(d);var f=r(a.size);o.view.appendChild(t("tr",{child:[t("td",{child:l,klass:"file"}),t("td",{child:n(f),klass:"size"}),t("td",{child:n(a.time),klass:"time"})]}))}),o.view}):i.file(e)},o}),base=function(){var e=GNN.URI.location();return e.local.pop(),e.local.pop(),e},api=function(e,t){var n=base();return n.local.push("api"),n.local.push(e+".cgi"),n.params=t||{},n.refresh=function(){return delete n.params.timestamp,n},n},setTitle=function(e){["title","subtitle","institute"].forEach(function(t){var n=GNN.UI.$(t);n&&(GNN.UI.removeAllChildren(n),n.appendChild(GNN.UI.$text(e[t])))}),document.title=[e.subtitle,e.title].join(" - ")},addLinks=function(e){e=e||[];var t=GNN.UI.$("footer");t&&e.reverse().forEach(function(e){var n=GNN.UI.$new("a",{attr:{href:e.uri},child:e.label});t.firstChild?t.insertBefore(n,t.firstChild):t.appendChild(n)})},reportFatalErrors=function(e){var t=GNN.UI.$new,n=function(e){if(e instanceof Array){var r=t("ul");return e.forEach(function(e){r.appendChild(t("li",{child:n(e)}))}),r}if("object"==typeof e){var i=t("dl");for(var o in e)i.appendChild(t("dt",{child:o})),i.appendChild(t("dd",{child:n(e[o])}));return i}return GNN.UI.$text(e+"")},r=GNN.UI.$("fatalerror");r.appendChild(t("h3",{child:"Error"}));var i=t("ul");e.forEach(function(e){var r=t("li",{child:e.message+" ("+e.reason+")"});e.detail&&r.appendChild(n(e.detail)),i.appendChild(r)}),r.appendChild(i)},jsonpFailure=function(e,t,n){var r={},i={uri:"preparing for request"};n.forEach(function(e){r[e]=(t[e]||i).uri}),reportFatalErrors([{message:"JSONP request failed:",reason:e,detail:r}])},apiPost=function(e,t,n,r){var i=function(e){var t=[];for(var n in e)t.push([n,e[n]].map(encodeURIComponent).join("="));return t.join(";")};n=n||function(){},r=r||function(){};var o=new XMLHttpRequest,a=api(e,{}),s="application/x-www-form-urlencoded";o.open("POST",a+""),o.setRequestHeader("Content-Type",s),o.onreadystatechange=function(){4==o.readyState&&(200<=o.status&&o.status<300?n(o):r(o))},o.send(i(t))},loadingIcon=function(){return GNN.UI.$new("img",{klass:"loading",attr:{src:"loading.gif"}})},makeExerciseSelector=function(e,t,n,r,i){var o=GNN.UI.$new,a=GNN.UI.Observer;r=r||"ex";var s=function(e,t){var s=r+e,c=o("input",{id:s,attr:{type:"checkbox",name:"ex",value:e}});if(i&&(new a(c,"onchange",i),new a(c,"onclick",i)),(n||[]).indexOf(e)>=0&&(c.checked=!0),t.level){for(var u="",l=t.level,d=0;l>d;d++)u+="★";e+="["+u+"]"}t.required&&(Math.abs(t.required)==(t.number||1)?(t.required>0&&(e+=" [必修]"),n||(c.checked=!0)):t.required instanceof Array||(e+=" [必修("+t.required+"問選択)]"));var f=o("label",{child:e,attr:{"for":s}});return{check:c,label:f}};t.forEach(function(t){var r=t[0],i=t[1]||{},c=o("li");i.sub&&i.sub.every(function(e){return(e[1]||{}).required})&&(i.required=i.sub.length,i.number=i.sub.length);var u=s(r+"",i);c.appendChild(u.check),c.appendChild(u.label);var l=[];if(i.sub){var d=o("ul");i.sub.forEach(function(e){var t=e[0],r=e[1]||{};i.required==i.sub.length&&(r.required=-1);var a=o("li"),c=s(t,r,n);a.appendChild(c.check),a.appendChild(c.label),d.appendChild(a),l.push(c.check)}),c.appendChild(d);var f=function(){u.check.checked=l.every(function(e){return e.checked})},p=function(e){var t=e.target().checked;l.forEach(function(e){e.checked=t})};l.forEach(function(e){new a(e,"onchange",f),new a(e,"onclick",f)}),new a(u.check,"onchange",p),new a(u.check,"onclick",p),f()}e.appendChild(c)})},deepEq=function(e,t){if(typeof e!=typeof t)return!1;if("object"==typeof e){if(e instanceof Array&&t instanceof Array){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!deepEq(e[n],t[n]))return!1;return!0}var r={};for(var i in e){if(!deepEq(e[i],t[i]))return!1;r[i]=!0}for(var o in t)if(!r[o])return!1;return!0}return e===t},Admin=function(e){"function"!=typeof e&&(e=e.record);var t=function(e,t,n,r){apiPost("admin_"+e,t,n,r)};return{editStatus:function(e,n,r){t("log",e,n,r)},editLog:function(e,n,r){t("log",e,n,r)},editSolved:function(e,n,r){t("solved",e,n,r)},runTest:function(e,n,r,i){var o={user:e,report:n};t("runtest",o,r,i)},update:e}},Model={};Model.Config=function(e){var t=e.master||{};return t.comment=e.comment||{},t.comment.enable&&(t.comment.enable="admin"!==t.comment.enable||t.admin),t.openAlways=1==e.user.length,t},Model.Report=function(e){return e.hasTest=e.record.some(function(e){return"test"==e.field}),e},Model.User=function(e){return e.getFields=function(t,n){GNN.XHR.json.retrieve({user:api("user",{report:t,user:e.token,type:"status",status:"record",log:1})},function(r){var i=GNN.inherit({},e);i.record=(r.user[0].report||{})[t]||{},n(i)},jsonpFailure)},e.getCommentCount=function(t,n){GNN.XHR.json.retrieve({comment:api("comment",{report:t,user:e.token,action:"news"})},function(e){n(e.comment||{})})},e},Model.UserList=function(e){return e=e.map(function(e){return new Model.User(e)}),e.getFields=function(t,n){GNN.XHR.json.retrieve({user:api("user",{report:t,type:"status",status:"record",log:1})},function(r){var i={};r.user.forEach(function(e){i[e.token]=e});var o=e.map(function(e){var n=GNN.inherit({},e);return n.record=(i[e.token].report||{})[t]||{},n});n(o)},jsonpFailure)},e.getCommentCount=function(t,n){GNN.XHR.json.retrieve({comment:api("comment",{report:t,dummy:GNN.URI.encode("%")+"&"+e.map(function(e){return"user="+GNN.URI.encode(e.token)}).join("&"),action:"list_news"})},function(e){n(e.comment||{})})},e};var History=function(){var e,t={},n=!1,r=function(){},i=function(){};return window.history.pushState&&(r=function(e,t,n){window.history.pushState(e,t,n)}),window.history.replaceState&&(i=function(e,t,n){window.history.replaceState(e,t,n)}),t.track=function(r){var i=!1;n||(n=!0,e=null,i=!0),r(t),i&&(n=!1)},t.next=function(e){n=!1,t.track(e)},t.push=function(o,a){if(a=a||(t.debug?"#debug":"#"),n){var s=document.getElementsByTagName("title")[0]||{};e?i(o,GNN.UI.text(s),a):(r(o,GNN.UI.text(s),a),e=o)}},t},Persistent=function(e,t){if("undefined"==typeof JSON)return{del:function(){return this},set:function(){return this},get:function(){return null}};var n=function(e){return JSON.stringify(e)},r=function(e){try{return JSON.parse(e)}catch(t){}},i=[];return{hash:r(e.value)||{},history:t,addHook:function(e){i.push(e)},move:function(e){var t=this.history,n=this.hash;return t.next(function(){t.push(n,e),/^#/.test(e)&&(location.href=e,t.push(n,e))}),this},reset:function(t){this.hash=t,e.value=n(this.hash)},del:function(e){e=Array.prototype.slice.call(arguments);var t;return this.set(e,t)},set:function(e,n){e instanceof Array||(e=[e]),e.length<=0&&e.push("");var r=e.concat([]),o=e.pop(),a=e.reduce(function(e,t){return"undefined"==typeof e[t]&&(e[t]={}),e[t]},this.hash),s=!deepEq(a[o],n);if(a[o]=n,s){var c=this;i.forEach(function(e){e(r,c.hash)}),t.push(this.hash)}return this.reset(this.hash),this},get:function(e){return e=Array.prototype.slice.call(arguments),e.length<=0?this.hash:e.reduce(function(e,t){return(e||{})[t]},this.hash)}}};if(Persistent.Entry=function(e,t){return arguments.length>1&&(t=Array.prototype.slice.call(arguments,1)),t instanceof Array||(t=[t]),{parent:e,history:e.history,keys:t,move:function(e){return this.parent.move(e),this},del:function(e){return e=Array.prototype.slice.call(arguments),this.parent.del.apply(this.parent,this.keys.concat(e))},set:function(e,t){return e instanceof Array||(e=[e]),this.parent.set(this.keys.concat(e),t),this},get:function(e){return e=Array.prototype.slice.call(arguments),this.parent.get.apply(this.parent,this.keys.concat(e))}}},"undefined"==typeof KeyEvent)var KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_SEMICOLON:59,DOM_VK_LEFT_SHIFT:60,DOM_VK_EQUALS:61,DOM_VK_RIGHT_SHIFT:62,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_CONTEXT_MENU:93,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224};var KeyMap=function(){var e=function(e,t,n){return Array.prototype.slice.call(e,t,n)},t=function(e){var t=function(e,t,n){return n.toUpperCase()};return e.replace(/(^|_)(.)/g,t)},n={back_space:"BS",escape:"Esc",space:"Space",insert:"Ins","delete":"Del",semicolon:";",left_shift:"<",equals:"=",right_shift:">",subtract:"-",comma:",",period:".",slash:"/",back_quote:"`",open_bracket:"[",back_slash:"\\",close_bracket:"]",quote:"'"},r={},i={" ":32,"<":60};for(var o in KeyEvent)if(/^DOM_VK_(?![A-Z0-9]$)/.test(o)){var a=KeyEvent[o];o=o.substr("DOM_VK_".length).toLowerCase();var s=t(o.replace(/^numpad/,"num"));o in n&&(s=n[o]),r[a]=s}r[60]="<",r[186]=";",r[187]="=",r[189]="-";var c=function(e){var t=e.split(/ +/);return t.reduce(function(e,t){return e.escape?e.l[e.l.length-1]+=" "+t:e.l.push(t),e.escape=/\\$/.test(t),e},{l:[],escape:!1}).l},u=function(e){var t,n,o="",a="keyup"==e.type?0:e.charCode;return 0==a?e.keyCode in r?(e.shiftKey&&(n=!0),t=r[e.keyCode]):a=e.keyCode:31>a&&(13==a||27==a?(e.shiftKey&&(n=!0),t=r[a]):e.ctrlKey&&(t=String.fromCharCode(a+96),e.shiftKey&&(t=t.toUpperCase()))),a>0&&!t&&(t=String.fromCharCode(a),t in i?(/^\s$/.test(t)&&e.shiftKey&&(n=!0),t=r[i[t]]):0==e.charCode&&(t=t.toLowerCase(),t!=t.toUpperCase()?e.shiftKey&&(t=t.toUpperCase()):e.shiftKey&&(n=!0))),e.ctrlKey&&"Control"!=t&&(o+="C-"),e.altKey&&"Alt"!=t&&(o+="A-"),e.metaKey&&"Meta"!=t&&(o+="M-"),n&&"Shift"!=t&&(o+="S-"),t?o+t:void 0},l={},d=function(t){var n={},r=this,i=function(e,r){var i=c(e);if(i.length<1)throw new TypeError("Empty key sequence");if(1==i.length)n[i[0]]=r;else{var o=i.shift(),a=n[o];a instanceof KeyMap||(a=n[o]=new KeyMap(t)),a.define(i.join(" "),r)}};r.define=function(t,n){for(var r=e(arguments);r.length>0;)t=r.shift(),n=r.shift(),i(t,n)},r.lookup=function(e){var t=e;e instanceof Event&&(t=u(e));var r=t instanceof Array?t:c(t),i=n[r.shift()];return 0==r.length?i:i instanceof KeyMap?i.lookup(r):void 0},r.exec=function(e){var n=this.lookup(e);return"string"==typeof n&&(n=t[n]),"function"==typeof n?n.call(t):n}},f=function(e){if(e!==l){var t=new f(l);return d.apply(t,arguments),t}};return f.Proxy=function(e,t){var n=new KeyMap(e);return n.parent=t||{lookup:function(){},exec:function(){}},n.lookup_=n.lookup,n.exec_=n.exec,n.lookup=function(e){var t=n.lookup_(e);return t?t:n.parent.lookup(e)},n.exec=function(e){var t=n.lookup_(e);return t?n.exec_(e):n.parent.exec(e)},n},f.split=c,f.description=u,f}(),Selector=function(e,t,n){var r={selected:null},i={},o=function(e){return"string"==typeof e?function(t,n){var r=t[e]||function(){};r.call(t,t,n)}:(e=e||function(){},function(t,n){return e.call(t,t,n)})};return e=e||{},e.select=o(e.select),e.unselect=o(e.unselect),t=o(t),n=o(n),r.add=function(e,t){return i[e]=t,t},r.forEach=function(e){for(var t in i)e(t,i[t])},r.select=function(o){return r.forEach(function(e){return e==o?t(i[e]):n(i[e])}),r.selected=i[o],r.selected?e.select(i[o],o):void 0},r.unselect=function(t){return n(i[t]),r.selected==i[t]?(r.selected=null,e.unselect(i[t],t)):void 0},r.get=function(e){return i[e]},r},CompoundView=function(e){var t=function(t){var n=e.selected||{},r=n[t]||function(){};return function(){return r.apply(n,arguments)}},n=function(t){return function(){var n=arguments;e.forEach(function(e,r){r[t].apply(r,n)})}};return{setup:function(e,t,r){n("setup")(e,t,r)},put:function(e,t,r){n("put")(e,t,r)},activate:function(){return t("activate")()},deactivate:function(){return t("deactivate")()},open:function(){n("open").apply(null,arguments)},close:function(){n("close").apply(null,arguments)},keymap:function(){return t("keymap")()}}},Field=function(){var e={status:[["","未提出"],["OK","受理"],["NG","要再提出"],["build","確認中"],["check","確認中"],["build:NG","要再提出"],["check:NG","要再提出"],["report","レポート確認中"]]},t=GNN.UI.isNode,n=function(t,n){var r=GNN.UI.$new("a",{child:"✏",klass:"edit",attr:{href:".",title:"変更する"}}),i={node:r,callback:null};return new GNN.UI.Observer(r,"onclick",function(r){r.stop(),showDropdown(n,e.status.map(function(e){return{value:e[0],label:e[0]+" ("+e[1]+")",selected:e[0]==t}}),i.callback||function(){})}),i},r=GNN.inherit(function(e,t,n,r,i){var o=r[n]||(r.record||{})[n];o||r.record||(o=loadingIcon());var a=r.record||{};a.prefix=t,a.id=[t,r.token,n].join("-");var s=e(i,o,n,a);return s.node=i,s.data=o,s},{name_:function(e,t,n,i){return e.id=i.id,r.other(e,t,n,i)},status:function(i,o,a,s){if(t(o))return r.other(i,o,a,s);"boolean"==typeof o&&o&&(o="OK");var c=(o||"none").replace(/[^a-zA-Z]/g,"-");GNN.UI.appendClass(i,c);var u=e.status.reduce(function(e,t){return e||t[0]==(o||"")&&t[1]},null)||"",l=GNN.UI.$new("a",{id:s.id,klass:[s.prefix,a].join("-"),child:u,attr:{href:"."}}),d=r.other(i,l,a,s);return d.label=u,d.a=l,d.edit=n(o||"",l),d},unsolved:function(e,n,i,o){return t(n)?r.other(e,n,i,o):(n=(n||[]).map(function(e){return 1==e[1]?e[0]:e[0]+"のうち残り"+e[1]+"問"}).join(", "),r.other(e,n,i,o))},test:function(e,n,i,o){if(t(n))return r.other(e,n,i,o);if(o.log&&o.log.test){var a=o.log.test;n=a.passed==a.number?a.passed+"/"+a.number:GNN.UI.$new("span",{child:[GNN.UI.$new("em",{child:a.passed}),"/"+a.number]})}return r.other(e,n,i,o)},optional:function(e,n,i,o){if(t(n))return r.other(e,n,i,o);if(null==n)return r.other(e,"",i,o);if(0==n.length)return r.other(e,"0",i,o);var a=GNN.UI.$new("a",{attr:{href:"."},child:n.length+""}),s=!1;return new GNN.UI.Observer(a,"onclick",function(e){e.stop();var t=(e.event.element,e.target());GNN.UI.removeAllChildren(t),t.appendChild(s?GNN.UI.$text(n.length):GNN.UI.$text(n.join(", "))),s=!s}),r.other(e,a,i,o)},other:function(e,t){return e.appendChild(GNN.UI.$node(t)),{}},factory:function(e,t,n,i){var o=r[t]||r[t+"_"];return o||(o=/^optional/.test(t)?r.optional:r.other),i=i||GNN.UI.$new("td",{klass:t}),new r(o,e,t,n,i)}});return r}(),notifyUnreadCount=function(e,t){var n={root:e,tag:"div",klass:"unread"};if(GNN.UI.$select(n).forEach(function(e){e.parentNode.removeChild(e)}),!(0>=t)){var r=GNN.UI.$new("div",{klass:"unread",child:t+""});e.firstChild?e.insertBefore(r,e.firstChild):e.appendChild(r)}},ReportView=function(e,t,n,r){var i="report",o={id:i},a=[],s=new Selector({select:function(e){e.open()},unselect:function(e){e.close(),l.hide(),s.forEach(function(e,t){t.show(!0)})}},"show","hide"),c=GNN.UI.$new("table",{id:n.id,klass:"record",attr:{summary:n.id},child:GNN.UI.$new("tr",{child:n.record.map(function(e){return GNN.UI.$new("th",{klass:e.field,child:e.label})})})}),u={record:function(e,t){var n=s.get(t);n&&(n.fields||{}).update&&(n.fields.update(),n.fields.update.comment())},comment:function(e,t){var n=s.get(t);n&&(n.fields||{}).update&&n.fields.update.comment()}},l=makeStatus(t,o,n,r,u),d=r.admin&&new Admin(u);e.appendChild(c),e.appendChild(l.window);var f=function(){t.parent.set("focus",n.id)};new GNN.UI.Observer(c,"onclick",f),new GNN.UI.Observer(l.window,"onclick",f);var p=function(){return r.openAlways?void 0:(t.history.track(function(){o.close()}),!0)},h=new KeyMap.Proxy(o);h.define("Down","next","j","next","Up","prev","k","prev","Esc",p,"Return",function(){return r.openAlways||0==a.length?void 0:s.selected?p():(t.history.track(function(){o.open(n.id,a[0])}),!0)});var v=function(e,o){var a=o.token,c={id:a,fields:o,node:e};r.admin&&(GNN.UI.appendClass(e,"selectable"),new GNN.UI.Observer(e,"onclick",function(e){c.toggle(),e.stop()}));var f=function(){u.record(n.id,c.fields.token)};return c.isOpen=function(){return t.get("selected")==a},c.open=function(){t.set("selected",a),c.show()},c.close=function(){c.isOpen()&&(t.del("selected"),l.hide()),c.hide()},c.toggle=function(){t.history.track(function(){c.isOpen()?s.unselect(a):s.select(a)})},c.show=function(e,o){var a=c.fields,u=a.token,p=a.record,h=c.node,v=t.get("selected");"undefined"==typeof v||c.isOpen()?(h.style.display="",c.isOpen()?(s.selected=c,o||l.show(u,"log"),GNN.UI.appendClass(h,"selected")):GNN.UI.removeClass(h,"selected")):c.hide(),e||(GNN.UI.removeAllChildren(h),n.record.forEach(function(e){var o=[i,n.id].join("-"),s=e.field,l=Field.factory(o,s,a);if("status"==s){if(l.a)if(r.openAlways){t.set("selected",u);var v=GNN.UI.$node(l.label);l.node.replaceChild(v,l.a)}else new GNN.UI.Observer(l.a,"onclick",function(e){e.stop(),c.toggle()});if(l.edit&&r.admin&&(l.node.appendChild(l.edit.node),l.edit.callback=function(e){d.editStatus({id:p.submit,user:u,report:n.id,status:e},f,f)}),"check"==l.data&&"auto"==n.update){var m=l.node;m.insertBefore(loadingIcon(),m.firstChild)}}h.appendChild(l.node)}),c.updateComment())},c.hide=function(){c.node.style.display="none"},c.updateComment=function(){var e=c.fields,t=e.comment||{},r=e.token,o=GNN.UI.$([i,n.id,r,"name"].join("-"));if(o&&notifyUnreadCount(o,t.unreads||0),c.isOpen()){var a=(l.tabs||{}).comment;if(a){var s=l.tabButton("comment"),u=s.lastChild;notifyUnreadCount(s,t.unreads||0),GNN.UI.removeAllChildren(u);var d=a.label+"("+(t.comments||0)+")";u.appendChild(GNN.UI.$node(d))}}},c};return o.put=function(e,t,n){var r=s.get(t);r||(r=new v(GNN.UI.$new("tr"),n),c.appendChild(r.node),s.add(t,r),a.push(t)),r.fields=n,"comment"==n.reason?r.updateComment():r.show(!1,"record"!=n.reason)},o.open=function(e,t){s.select(t)},o.close=function(){t.del("selected"),s.selected&&s.unselect(s.selected.id)},o.next=function(){var e=a.indexOf((s.selected||{}).id);
return e>=0&&e+1<a.length?(t.history.track(function(){s.select(a[e+1])}),!0):void 0},o.prev=function(){var e=a.indexOf((s.selected||{}).id);return e>0?(t.history.track(function(){s.select(a[e-1])}),!0):void 0},o.focus=function(){r.openAlways||GNN.UI.appendClass(c,"focus");var e=GNN.UI.getPosition(c);window.scrollTo(e.x,e.y)},o.blur=function(){GNN.UI.removeClass(c,"focus")},o.keymap=function(){return h.parent=l.keymap(),h},o};ReportView.Parent=function(e,t){var n=new Selector({},"focus","blur");t.addHook(function(e,t){"focus"==e[0]?n.select(t.focus):"report"==e[0]&&(n.select(e[1]),t.focus=e[1])});var r={id:"report",label:"課題ごと"},i=[],o=!1,a=new KeyMap.Proxy(r);a.define("Left","prev","h","prev","Right","next","l","next");var s=GNN.UI.$new("div",{id:"report_view",klass:"view"});return e.appendChild(s),r.setup=function(e,i,o){if(GNN.UI.removeAllChildren(s),e.forEach(function(e){r.push(e,o)}),!n.selected){var a=t.get("focus")||(e[0]||{}).id;n.select(a)}},r.push=function(e,r){var o=new Persistent.Entry(t,"report",e.id);n.add(e.id,new ReportView(s,o,e,r)),i.push(e.id)},r.put=function(e,t,r){var i=n.get(e);n.add(e,i),i.put(e,t,r)},r.activate=function(){s.style.display="",o=!0},r.deactivate=function(){s.style.display="none",o=!1},r.open=function(e,t){var r=n.get(e);r&&r.open(e,t)},r.close=function(e){var t=n.get(e);t&&t.close(e)},r.keymap=function(){var e=t.get("focus"),r=e&&n.get(e);return r&&(a.parent=r.keymap()),a},r.next=function(){var e=t.get("focus");if(e){var n=i.indexOf(e);return n>=0&&n+1<i.length?(t.set("focus",i[n+1]),!0):void 0}},r.prev=function(){var e=t.get("focus");if(e){var n=i.indexOf(e);return n>0?(t.set("focus",i[n-1]),!0):void 0}},r};var SummaryView=function(e,t){var n="summary",r={id:n,label:"一覧"},i={rs:[],us:[]},o=!1,a=function(e,t){var n={node:e,selector:t};return n.show=function(){e.style.display=""},n.hide=function(){t.forEach(function(e,t){t.close()}),e.style.display="none"},n},s=function(){var e={selected:null},t=new Selector({},"show","hide");return e.addRow=function(e,n){var r=new Selector({select:function(e){e.open()},unselect:function(e){e.close()}},"show","hide");return t.add(e,new a(n,r))},e.row=function(e){return t.get(e)},e.add=function(e,n,r){var i=t.get(n);i&&i.selector.add(e,r)},e.get=function(e,n){var r=t.get(n);return r?r.selector.get(e):void 0},e.select=function(n,r){t.select(r);var i=t.selected;i&&(i.selector.select(n),e.selected=i.selector.selected)},e.unselect=function(n){var r=e.selected;r&&r.rid==n&&(e.selected=null,r.close(),t.forEach(function(e,t){t.show()}))},e},c=new s,u=GNN.UI.$new("div",{id:"report_view",klass:"view"});e.appendChild(u);var l=GNN.UI.$new("table",{id:"summary",klass:"record",attr:{summary:"status summary"}}),d={record:function(e,t){var n=c.get(e,t);n&&(n.fields||{}).update&&(n.fields.update(),n.fields.update.comment())},comment:function(e,t){var n=c.get(e,t);n&&(n.fields||{}).update&&n.fields.update.comment()}},f=function(){if(c.selected){var e=c.selected.rid;return t.history.track(function(){r.close(e)}),!0}},p=new KeyMap.Proxy(r);p.define("Down","nextUser","j","nextUser","Up","prevUser","k","prevUser","Left","prev","h","prev","Right","next","l","next","Esc",f,"Return",function(){return 0!=i.length?c.selected?f():(t.history.track(function(){r.open(i.rs[0],i.us[0])}),!0):void 0});var h=function(e,r,i,o,a){var s=r.id,u=i.token,l={rid:s,uid:u,fields:i,node:e},f=new Persistent.Entry(t,"summary"),p=function(){d.record(s,u)},h=a.admin&&new Admin(d);return l.isOpen=function(){return f.get(s,"selected")==u},l.open=function(){var e=f.get();for(var t in e)f.del(t,"selected");f.set([s,"selected"],u),f.set("user",u),l.show()},l.close=function(){l.isOpen()&&(f.del(s,"selected"),o.hide()),l.hide()},l.toggle=function(){f.history.track(function(){l.isOpen()?(l.close(),c.unselect(s)):c.select(s,u)})},l.show=function(e,t){var i=l.fields,d=i.record,v=l.node,m=l.node.parentNode;if(f.get("user")==u||l.isOpen()?(m.style.display="",l.isOpen()?(c.selected=l,t||o.show(u,"log"),GNN.UI.appendClass(v,"selected")):GNN.UI.removeClass(v,"selected")):f.get("user")==u&&l.hide(),!e){GNN.UI.removeAllChildren(v);var N=[n,s].join("-"),y=r.field,w=Field.factory(N,y,i,v);if("status"==y&&(w.a&&new GNN.UI.Observer(w.a,"onclick",function(e){e.stop(),l.toggle()}),w.edit&&a.admin&&(w.node.appendChild(w.edit.node),w.edit.callback=function(e){h.editStatus({id:d.submit,user:u,report:s,status:e},p,p)}),"check"==w.data&&"auto"==r.update)){var g=w.node;g.insertBefore(loadingIcon(),g.firstChild)}l.updateComment()}},l.hide=function(){GNN.UI.removeClass(l.node,"selected"),o.hide()},l.updateComment=function(){var e=l.fields,t=e.comment||{},r=(e.token,GNN.UI.$([n,s,u,"status"].join("-")));if(r=(r||{}).parentNode,r&&notifyUnreadCount(r,t.unreads||0),l.isOpen()){var i=(o.tabs||{}).comment;if(i){var a=o.tabButton("comment"),c=a.lastChild;notifyUnreadCount(a,t.unreads||0),GNN.UI.removeAllChildren(c);var d=i.label+"("+(t.comments||0)+")";c.appendChild(GNN.UI.$node(d))}}},l.keymap=function(){return o.keymap()},l},v={};return r.setup=function(e,n,o){GNN.UI.removeAllChildren(u),GNN.UI.removeAllChildren(l),u.appendChild(l);var a=function(e,t,n){return e.some(function(e){return t==e.field?n=e.label:!1}),n},s=e.map(function(e,t){return{field:"status",i:t}});s.unshift({field:"name",i:0}),s.map(function(t){return t.label=a(e[t.i].record,t.field),t.id=e[t.i].id,t.update=e[t.i].update,t}).filter(function(e){return e.label});var f=GNN.UI.$new("tr");s.forEach(function(e){f.appendChild(GNN.UI.$new("th",{className:e.field,child:e.label}))}),l.appendChild(f),e.forEach(function(e){i.rs.push(e.id);var n=new Persistent.Entry(t,"summary",e.id);v[e.id]=makeStatus(n,r,e,o,d),u.appendChild(v[e.id].window)});var p=t.get("summary","user");n.forEach(function(t){i.us.push(t.token);var n=GNN.UI.$new("tr");l.appendChild(n);var r=c.addRow(t.token,n);p&&p!=t.token&&r.hide(),s.forEach(function(r){var i=e[r.i],a=GNN.UI.$new("td",{klass:r.field});n.appendChild(a);var s;if("name"==r.field){var u={show:function(){},hide:function(){}};s=new h(a,r,t,u,o),s.show()}else s=new h(a,r,t,v[i.id],o),GNN.UI.appendClass(a,"selectable"),new GNN.UI.Observer(a,"onclick",function(e){s.toggle(),e.stop()}),c.add(i.id,t.token,s)})})},r.put=function(e,t,n){var r=c.get(e,t);r&&(r.fields=n,"comment"==n.reason?r.updateComment():r.show(!1,"record"!=n.reason))},r.activate=function(){u.style.display="",o=!0},r.deactivate=function(){u.style.display="none",o=!1},r.open=function(e,t){c.select(e,t)},r.close=function(e){c.unselect(e)},r.next=function(){var e=c.selected;if(e){var n=i.rs.indexOf(e.rid);return n>=0&&n+1<i.rs.length?(t.history.track(function(){r.open(i.rs[n+1],e.uid)}),!0):void 0}},r.prev=function(){var e=c.selected;if(e){var n=i.rs.indexOf(e.rid);return n>0?(t.history.track(function(){r.open(i.rs[n-1],e.uid)}),!0):void 0}},r.nextUser=function(){var e=c.selected;if(e){var n=i.us.indexOf(e.uid);return n>=0&&n+1<i.us.length?(t.history.track(function(){r.open(e.rid,i.us[n+1])}),!0):void 0}},r.prevUser=function(){var e=c.selected;if(e){var n=i.us.indexOf(e.uid);return n>0?(t.history.track(function(){r.open(e.rid,i.us[n-1])}),!0):void 0}},r.keymap=function(){var e=c.selected;return p.parent=e?e.keymap():null,p},r},showDropdown=function(e,t,n){var r=e.parentNode,i=GNN.UI.$new("select",{child:t.map(function(e){var t=GNN.UI.$new("option",{attr:{value:e.value},child:e.label});return e.selected&&(t.selected="selected"),t})});new GNN.UI.Observer(i,"onchange",function(e){e.target().blur(),n(e.target().value)}),r.replaceChild(i,e),i.focus(),new GNN.UI.Observer(i,"onblur",function(t){r.replaceChild(e,t.target())})},makeStatus=function(e,t,n,r,i){var o=t.id+"-"+n.id,a=r.admin&&new Admin(i),s=new LogView(o,n.id,a),c=new SolvedView(o,n.id,a),u=new TestResultView(o,n.id,a),l=new FileBrowserView(o,n.id),d=new CommentView(o,n.id,i,a),f=[[!0,s],[!0,c],[r.admin||n.hasTest,u],[!0,l],[r.comment.enable,d],[]];return f=f.reduce(function(e,t){return e.concat(t[0]?t[1]:[])},[]),new StatusWindow(o,f,e)},StatusWindow=function(e,t,n){var r=function(t,n){return GNN.UI.$new(t,{id:[e,"status",n].join("_"),klass:["status",n].join("_")})},i=r("div","window"),o=r("div","header"),a=r("ul","toolbar"),s=r("ul","tabbar"),c=r("div","view");i.appendChild(o),i.appendChild(c),o.appendChild(a),o.appendChild(s);var u=function(t){return[e,t,"tab"].join("_")},l={persistent:new Persistent.Entry(n,"tabs"),window:i,target:null,tabs:{},list:[],select:function(e){n.history.track(function(){l.target&&l.show(l.target,e,!0)})},next:function(){var e=this.persistent.get("selected"),t=this.list.indexOf(e);return t>=0&&t+1<this.list.length?(this.select(this.list[t+1]),!0):t+1==this.list.length?(this.select(this.list[0]),!0):void 0},prev:function(){var e=this.persistent.get("selected"),t=this.list.indexOf(e);return t>0?(this.select(this.list[t-1]),!0):0==t?(this.select(this.list[this.list.length-1]),!0):void 0},add:function(e){this.tabs[e.name]=e,this.list.push(e.name);var t=this,n=GNN.UI.$new("a",{attr:{href:"."}});n.appendChild(GNN.UI.$text(e.label)),new GNN.UI.Observer(n,"onclick",function(n){n.stop(),t.select(e.name)});var r=this.tabButton(e.name,n);s.appendChild(r)},tabButton:function(e,t){var n=[u(e),"button"].join("_"),r=GNN.UI.$(n);return r||(r=GNN.UI.$new("li",{id:n,child:t||[],klass:"status_tabbar_button"})),r},set:function(e){GNN.UI.removeAllChildren(c),e&&(e instanceof Array||(e=[e]),e.forEach(function(e){c.appendChild(GNN.UI.$node(e))}))},show:function(e,t,n){this.target=e;var r=this.persistent.get("selected");t=!n&&r||t,this.persistent.set("selected",t);for(var o in this.tabs){var s=this.tabs[o],d=GNN.UI.$([u(s.name),"button"].join("_"));if(d)if(s.name==t){GNN.UI.appendClass(d,"selected"),GNN.UI.removeAllChildren(a),GNN.UI.removeAllChildren(c);var f={parent:a,reset:function(){GNN.UI.removeAllChildren(this.parent)},add:function(e,t){return this.parent.appendChild(GNN.UI.$new("li",{child:e,klass:t||""})),this},addButton:function(e){this.add(e,"toolbutton")}};s.show(e,f,l)}else GNN.UI.removeClass(d,"selected")}i.style.display="block"},hide:function(){i.style.display="none"}},d=new KeyMap(l);return d.define("Tab","next","S-Tab","prev"),l.keymap=function(){return d},(t||[]).forEach(function(e){l.add(e)}),l.hide(),l},ToolButton=function(e){var t=GNN.UI.$node("");return{button:e,parent:e.parentNode,alternative:null,enable:function(){e.parentNode!=this.parent&&this.parent.replaceChild(e,this.alternative)},disable:function(n){e.parentNode==this.parent&&(n&&(n=GNN.UI.$node(n)),this.alternative=n||t,e.blur(),this.parent.replaceChild(this.alternative,e))}}},editMode=function(e,t,n,r,i){var o=GNN.UI.$new("input",{attr:{type:"submit",value:"変更"}}),a=GNN.UI.$new("input",{attr:{type:"button",value:"キャンセル"}}),s=GNN.UI.$new("form",{attr:{action:"."}});e(s),s.appendChild(o),s.appendChild(a);var c=function(e){e.stop(),r.enable(),t()},u=function(){r.enable(),n.set(i)};new GNN.UI.Observer(s,"onsubmit",c),new GNN.UI.Observer(a,"onclick",u),r.disable("編集中"),n.set(s)},LogView=function(e,t,n){var r=function(e){return GNN.UI.$new("pre",{child:GNN.UI.$node(e)})},i=[{prop:"timestamp",label:"ステータス更新日時",node:GNN.UI.$node},{prop:"submit",label:"提出日時",node:GNN.UI.$node},{prop:"initial_submit",label:"初回提出",node:GNN.UI.$node},{prop:"message",label:"メッセージ",node:GNN.UI.$node,editable:!0},{prop:"error",label:"エラー",node:r,editable:!0},{prop:"reason",label:"エラーの詳細",node:r,editable:!0},{prop:"test",label:"テスト通過率",node:function(e){var t;return null===e?t=GNN.UI.$node("0/0"):(t=GNN.UI.$node(e.passed+"/"+e.number),e.passed!==e.number&&(t=GNN.UI.$new("em",{child:t}))),t}}],o=function(e,t,n){var r=[],o={};return i.forEach(function(i){var a=t.reduce(function(e,t){return e||t[i.prop]},null);if(a||i.editable&&n){e.appendChild(GNN.UI.$new("dt",{klass:i.prop,child:i.label}));var s;n&&i.editable?(s=GNN.UI.$new("textarea",{attr:{cols:80,rows:2},child:a||""}),o[i.prop]=s):s=i.node(a),e.appendChild(GNN.UI.$new("dd",{klass:i.prop,child:s})),r.push(i.prop)}}),{keys:r,params:o}},a=function(e){if(!e.timestamp&&!e.log)return"なし";var t=GNN.UI.$new("dl",{klass:"log_msg"}),n=o(t,[e,e.log]).keys;for(var i in e.log)n.indexOf(i)<0&&(t.appendChild(GNN.UI.$new("dt",{klass:"etc",child:i})),t.appendChild(GNN.UI.$new("dd",{klass:"etc",child:r(e.log[i])})));return t},s=function(e,r,i,a,s){var c=GNN.UI.$new("dl",{klass:"log_msg"}),u=o(c,[r,r.log],!0).params;editMode(function(e){e.appendChild(c)},function(){var i={};for(var o in u){var a=u[o];0!=a.value.length&&(i[o]=a.value)}i.id=r.submit,i.user=e,i.report=t;var s=function(){n.update(t,e)};n.editLog(i,s,s)},i,new ToolButton(a),s)},c={name:"log",label:"ログ",show:function(e,r,i){i.set(loadingIcon()),GNN.XHR.json.retrieve({user:api("user",{report:t,user:e,type:"status",status:"record",log:1})},function(o){var c=((o.user[0]||{}).report||[])[t],u=a(c||{});if(i.set(u),n&&c){var l=GNN.UI.$new("a",{attr:{href:"."},child:"✏ 編集"});r.reset(),r.addButton(l),new GNN.UI.Observer(l,"onclick",function(t){t.stop(),s(e,c,i,t.target(),u)})}},function(){i.set("読み込み失敗")})}};return c},SolvedView=function(e,t,n){var r=function(e){var r=function(n,r){return n=n.reduce(function(t,n){return n.token==e?n:t},{}).report,(n=((n||{})[t]||{})[r])?n=n.map(function(e){return e instanceof Array?e[0]:e}):void 0},i=function(e,t,n){if(e=r(e,t)){var i=GNN.UI.$new("h3",{child:n}),o=[i];if(e.length>0){var a=GNN.UI.$new("ul",{klass:t});e.forEach(function(e){a.appendChild(GNN.UI.$new("li",{child:e}))}),o.push(a)}else o.push(GNN.UI.$new("p",{child:"なし"}));return o}},o=function(r,i,o,a){i.set(loadingIcon());var s=new ToolButton(o);s.disable();var c=GNN.UI.$new("ul",{klass:"ex"}),u=GNN.UI.$new("div",{klass:"list_view",child:c}),l=api("scheme",{id:t,exercise:!0});GNN.XHR.json.retrieve({result:l},function(o){var l=o.result[0].exercise;makeExerciseSelector(c,l,r,["ex",t].join("_")),editMode(function(e){e.appendChild(u)},function(){for(var r=c.getElementsByTagName("input"),i=[],o=0;o<r.length;o++)r[o].checked&&i.push(r[o].value);var a=function(){n.update(t,e)};n.editSolved({user:e,report:t,exercise:i.join(",")},a,a)},i,s,a)},function(){i.set(a)})};return{show:function(a,s){s.set(loadingIcon());var c=api("user",{user:e,report:t,type:"status",status:"solved"}),u=api("user",{user:e,report:t,type:"status",status:"record"});GNN.XHR.json.retrieve({solved:c,unsolved:u},function(e){var t=i(e.solved,"solved","解答済み");if(!t)return void s.set("なし");var c=i(e.unsolved,"unsolved","未解答"),u=t.concat(c||[]);if(s.set(u),n){var l=GNN.UI.$new("a",{attr:{href:"."},child:"✏ 編集"});a.reset(),a.addButton(l),new GNN.UI.Observer(l,"onclick",function(t){t.stop();var n=r(e.solved,"solved");o(n||[],s,t.target(),u)})}},function(){s.set("読み込み失敗")})}}},i={};return{name:"solved",label:"解答状況",show:function(e,t,n){i[e]||(i[e]=new r(e)),i[e].show(t,n)}}},TestResultView=function(e,t,n){var r=GNN.UI.$new,i=function(e){var i=function(e){return r("h3",{child:e})},o=function(e){return GNN.UI.$new("pre",{child:GNN.UI.$node(e)})},a=function(e){return"string"!=typeof e&&(e=e.result),new RegExp("^\\s*ok\\s*","i").test(e)},s=function(e){return c.map(function(t){return e[t.prop]}).filter(function(e){return!!e}).length<=1},c=[{prop:"result",name:"result",node:function(e){return a(e)?"passed":"failed"}},{prop:"description",name:"test",node:o},{prop:"expected",name:"expected",node:o},{prop:"returned",name:"returned",node:o},{prop:"exception",name:"error",node:o}];return{show:function(o,u){if(u.set(loadingIcon()),n){var l=r("a",{attr:{href:"."},child:"⚡ テストを再実行"});o.reset(),o.addButton(l),new GNN.UI.Observer(l,"onclick",function(r){r.stop(),n.runTest(e,t,function(){n.update(t,e)})})}var d=api("test_result",{user:e,report:t});GNN.XHR.json.retrieve({test:d},function(e){var t=e.test;if(!t||"undefined"==typeof t.passed||"undefined"==typeof t.number)return void u.set("なし");var n=[i("通過率"),r("p",{child:t.passed==t.number?t.passed+"/"+t.number:[GNN.UI.$new("em",{child:t.passed}),"/"+t.number]}),i("詳細")];if(t.detail){var o=r("dl",{klass:"testcase",child:t.detail.reduce(function(e,t){t.result||(t.result="fail");var n=r("table",{child:c.reduce(function(e,n){var i=t[n.prop];if(i){var o=n.node(i),a=r("tr",{child:[r("th",{child:n.name}),r("td",{child:o})]});return e.concat([a])}return e},[])});s(t)&&(n="");var i=a(t)?"passed":"failed";return e.concat([r("dt",{child:t.name,klass:i}),r("dd",{child:n,klass:i})])},[])});n.push(o)}else n.push(GNN.UI.$new("p",{child:"非公開"}));u.set(n)},function(){u.set("読み込み失敗")})}}},o={};return{name:"test",label:"テスト結果",show:function(e,t,n){o[e]||(o[e]=new i(e)),o[e].show(t,n)}}},FileBrowserView=function(e,t){var n=GNN.UI.$new,r=GNN.UI.$text,i=function(r,i){var o=n("ul",{id:[e,"breadcrum"].join("_"),klass:"breadcrums"}),a=function(e){return e.split("/").reduce(function(e,t){return e[1].push(t),e[0].push({name:t,path:e[1].join("/")}),e},[[],[]])[0]};return{set:function(s){GNN.UI.$([e,"breadcrum"].join("_"))||i.add(["場所:",o]),GNN.UI.removeAllChildren(o);var c=a(s.path).map(function(e){return e.type="dir",e});c[c.length-1].type=s.type,c.forEach(function(e){"."==e.name&&(e.name=t);var i=n("a",{child:e.name,attr:{href:r.path2uri(e.path)}});new GNN.UI.Observer(i,"onclick",function(t){t.stop(),r.onMove(e)}),o.appendChild(n("li",{child:i}))})}}},o=function(e){var o=function(e){return[["&","%26"],["\\?","%3F"]].reduce(function(e,t){return e.replace(new RegExp(t[0],"g"),t[1])},encodeURI(e))},a=function(e){return e.path=o(e.path),api("browse",e)},s=function(e,t,n){var r=base(),i=o(n);return r.local.push("browse",e,t,i),n!=i&&(r.params.path=i),r+""},c={location:{path:".",type:"dir"},breadcrum:null,toolbar:null,view:null,persistent:null,reset:function(e){this.view.set(loadingIcon()),this.location=e,this.persistent.set("location",e),this.toolbar.reset(),this.breadcrum.set(e)},path2uri:function(n){return s(e,t,n)},path:function(e){return this.path2uri(e.path)},icon:function(e){return n("img",{attr:{src:"./"+e.type+".png"},klass:"icon"})},dir:function(n,i){"."==n.path&&(n.name=t),this.reset(n),new GNN.XHR.json(a({user:e,report:t,path:n.path}),function(e){i(e),c.view.set(i(e))},function(){c.view.set(r("読み込み失敗"))})},file:function(i){delete i.time,this.reset(i),this.toolbar.addButton(n("a",{child:"⏎ 直接開く",attr:{href:this.path2uri(i.path)}}));var o=new XMLHttpRequest,s=a({user:e,report:t,type:"highlight",path:i.path});s.params.timestamp=encodeURI(new Date),o.open("GET",s+""),o.onreadystatechange=function(){if(4==o.readyState)if(200<=o.status&&o.status<300&&o.responseText){var e=n("div"),t=o.responseText;t=t.replace(/<pre>\n/,"<pre>"),e.innerHTML=t,pre=e.getElementsByTagName("pre")[0],u.open(pre.innerHTML+""),u.applyStyleFromSource(o.responseText),c.view.set(u.view)}else c.view.set(r("読み込み失敗"))},o.send(null)},onMove:function(e){var t=this;this.persistent.history.track(function(){t.move(e)})}},u=new FileBrowser.FileViewer,l=new FileBrowser({handler:c});return c.move=function(e){l.move(e)},c.show=function(t,n){this.breadcrum=new i(this,t),this.toolbar=t,this.view=n;var r=[e,"browser"];this.persistent=new Persistent.Entry(this.view.persistent,r),this.move(this.persistent.get("location")||this.location)},c},a={};return{name:"file",label:"ファイル一覧",show:function(e,t,n){a[e]||(a[e]=new o(e)),a[e].show(t,n)}}},CommentView=function(e,t,n,r){var i=GNN.UI.$new,o=function(e){return e=e||[],e.indexOf("user")>=0&&e.indexOf("other")>=0?"全員に公開":e.indexOf("user")>=0?"提出者に公開":e.indexOf("other")>=0?"提出者以外に公開":"非公開"},a=function(a,s,c,u,l){u=u||{},u.content=u.content||"",u.acl=u.acl||c.acl||[];var d=i("textarea",{child:u.content,attr:{rows:6}});new GNN.UI.Observer(d,"onkeypress",function(e){e.stopPropagation()});var f=i("input",{attr:{type:"submit",value:"コメントする"}}),p=i("input",{attr:{type:"button",value:"プレビュー"}}),h=i("div",{klass:"form",child:[d,f,p]});if(l){var v=i("input",{attr:{type:"button",value:"キャンセル"}});new GNN.UI.Observer(v,"onclick",l),h.appendChild(v)}var m;r&&(m=[],["user","other"].forEach(function(t){var n=[e,"comment"+(u.id||""),"acl",t].join("_"),r=i("input",{id:n,attr:{type:"checkbox",name:t}});u.acl.indexOf(t)>=0&&(r.checked=!0);var a=i("label",{child:o([t]),attr:{"for":n}});h.appendChild(r),h.appendChild(a),m.push(r)}));var N=function(e){e.stop(),e.disable(),m&&(u.acl=m.filter(function(e){return e.checked}).map(function(e){return e.name}));var r={user:a,report:t,action:s,acl:u.acl.join(","),message:d.value};if(""==d.value.replace(/\s*/,""))return void e.enable();"undefined"!=typeof u.id&&(r.id=u.id+"");var i=function(){n.record(t,a)};apiPost("comment",r,i,function(t){if(400==t.status){var n=t.responseText;if(/size limit exceeded/.test(n))return alert("コメントが長過ぎます"),void e.enable()}i()})},y=function(e){e.stop();var t=e.target();apiPost("comment",{action:"preview",message:d.value},function(e){var n=i("div",{klass:"preview message"});n.innerHTML=e.responseText,d.parentNode.replaceChild(n,d);var r=i("input",{attr:{type:"button",value:"再編集"}});new GNN.UI.Observer(r,"onclick",function(e){e.stop();var r=e.target();n.parentNode.replaceChild(d,n),r.parentNode.replaceChild(t,r)}),t.parentNode.replaceChild(r,t)},function(){alert("プレビュー失敗")})};return new GNN.UI.Observer(f,"onclick",N),new GNN.UI.Observer(h,"onsubmit",N),new GNN.UI.Observer(p,"onclick",y),h},s={name:"comment",label:"コメント",show:function(s,c,u){u.set(loadingIcon());var l=function(){n.record(t,s)};GNN.XHR.json.retrieve({master:api("master",{user:!0}),config:api("comment",{action:"config"}),entries:api("comment",{user:s,report:t,action:"get"}),news:api("comment",{user:s,report:t,action:"news"})},function(c){var d,f,p=i("ul",{klass:"comments"}),h=(c.news||{}).unreads||0;c.entries.forEach(function(n,u){var v=n.id,m=[e,s,"comment"+v].join("-");d=v,u+h==c.entries.length&&(f=m);var N=i("p",{klass:"edit"}),y=i("div",{klass:"meta",child:[i("p",{klass:"author",child:n.user_name}),N,i("p",{klass:"acl",child:o(n.acl)}),i("p",{klass:"date",child:n.create})]}),w=i("div",{klass:"message"});if(w.innerHTML=n.content,p.appendChild(i("li",{id:m,child:[y,w],klass:0==(n.acl||[]).length?"private":""})),r||n.user==c.master.user){var g=i("a",{child:"✏",attr:{href:".",title:"編集する"}}),_=i("a",{child:"✖",attr:{href:".",title:"削除する"}});N.appendChild(g),N.appendChild(_);var b=function(e){var t,n=s,r=c.config,i=w.parentNode,o=function(e){e.stop(),i.replaceChild(w,t)};t=a(n,"edit",r,e,o),i.replaceChild(t,w);var u=t.getElementsByTagName("textarea");u[0]&&u[0].focus()};new GNN.UI.Observer(g,"onclick",function(e){e.stop(),new GNN.XHR.json(api("comment",{user:s,report:t,action:"get",id:v,type:"raw"}),function(e){b(e[0]||{})})}),new GNN.UI.Observer(_,"onclick",function(e){e.stop(),confirm("このコメントを削除しますか?")&&apiPost("comment",{action:"delete",user:s,report:t,id:v+""},l,l)})}}),d&&apiPost("comment",{action:"read",user:s,report:t,id:d+""},function(){n.comment(t,s)});var v;v=c.config.max<=c.entries.length?"コメント数が上限に達しました":a(s,"post",c.config),p.appendChild(i("li",{child:v})),u.set(p),f&&u.persistent.move("#"+f)},function(){u.set("読み込み失敗")})}};return s},init=function(e){var t=api("master",{year:!0,token:!0,admin:!0}),n=api("user"),r=api("scheme",{record:!0}),i=api("template",{type:"record",links:!0}),o=api("comment",{action:"config"}),a=GNN.UI.$(e),s=new History,c=new Persistent(GNN.UI.$("persistent"),s),u="#";/#debug$/.test(location.href)&&(GNN.UI.appendClass(GNN.UI.$("persistent"),"debug"),u="#debug",s.debug=!0);var l={div:GNN.UI.$new("div",{id:"view_switch"}),label:GNN.UI.$text("表示:"),ul:GNN.UI.$new("ul")};l.div.appendChild(l.label),l.div.appendChild(l.ul),a.appendChild(l.div);var d=loadingIcon();a.appendChild(d);var f=new Selector({select:function(e){c.set("view",e.id)}},function(e){var t=GNN.UI.$("sw_view_"+e.id);t&&GNN.UI.appendClass(t,"selected"),e.activate()},function(e){var t=GNN.UI.$("sw_view_"+e.id);t&&GNN.UI.removeClass(t,"selected"),e.deactivate()}),p=function(e,t){f.add(e,t);var n=GNN.UI.$new("a",{id:"sw_view_"+t.id,child:t.label,attr:{href:"."}});new GNN.UI.Observer(n,"onclick",function(t){c.history.track(function(){f.select(e)}),t.stop()});var r=GNN.UI.$new("li",{child:n});l.ul.appendChild(r)};p("report",new ReportView.Parent(a,c)),p("summary",new SummaryView(a,c));var h=new CompoundView(f),v={global:new KeyMap(null),nil:new KeyMap(null)};new GNN.UI.Observer(document,"onkeypress",function(e){var t=h.keymap()||v.nil,n=e.event;(t.lookup(n)?t.exec(n):v.global.exec(n))&&e.stop()}),new GNN.UI.Observer(window,"onpopstate",function(e){if(e.event.state){var t=e.event.state,n=(t||{}).view||"report",r=f.get(n),i=(t||{})[n]||{},o=(c.hash||{})[n]||{},a=[];for(var s in i)deepEq(i[s],o[s])||a.push(s);a.forEach(function(e){var t=i[e].selected;t||r.close(e)});var u=t.focus;delete t.focus,c.reset(t),a.forEach(function(e){var t=(i[e]||{}).selected;t&&r.open(e,t)}),c.set("focus",u),f.select(n)}});var m=function(e){var t=["master","scheme","comment","user"];if(t.every(function(t){return e[t]})){a.removeChild(d);var n=new Model.Config(e),r=e.scheme.map(function(e){return new Model.Report(e)}),i=new Model.UserList(e.user),o=c.get("focus")||(r[0]||{}).id;c.set("focus",o),h.setup(r,i,n),r.forEach(function(e){n.token&&n.openAlways&&f.forEach(function(t){var r=new Persistent.Entry(c,t,e.id);r.get("selected")||r.set("selected",n.token)});var t={};i.forEach(function(n){var r=n.token,i=e.id,o={},a=function(e){o.fields=e,e.update=s,e.comment=o.comment||{},e.reason="record",h.put(i,r,e)},s=function(){n.getFields(i,a)},c=function(e){var t=o.fields||n;o.comment=e,t.comment=e||{},t.update=s,t.reason="comment",h.put(i,r,t)};s.comment=function(){n.getCommentCount(i,c)},n.comment={},n.update=s,n.reason="initialize",h.put(i,r,n),t[r]={fields:a,comment:c}}),i.getFields(e.id,function(e){e.forEach(function(e){t[e.token].fields(e)})}),i.getCommentCount(e.id,function(e){for(var n in e)t[n].comment(e[n]||{})}),f.forEach(function(t){c.get(t,e.id)||c.set([t,e.id],{})})});var l="report";n.admin&&(l="summary"),f.select(c.get("view")||l),h.activate(),o&&(c.set("focus",o),n.token&&n.openAlways&&f.forEach(function(e,t){t.open(o,n.token)})),s.track(function(){s.push(c.hash,u)})}};async={template:function(e){setTitle(e.template),addLinks(e.template.links)},master:m,user:m,scheme:m,comment:m},GNN.XHR.json.retrieve({master:t,user:n,scheme:r,template:i,comment:o,timeout:6e4,async:async},null,jsonpFailure)};